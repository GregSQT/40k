#!/usr/bin/env python3
"""
Test script to debug LoS bug - Unit 5 at (10,5) shooting Unit 2 at (6,11) through walls.
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from engine.phase_handlers import shooting_handlers

# First test the hex line calculation
print("=" * 60)
print("HEX PATH TEST: (10,5) -> (6,11)")
print("=" * 60)
hex_path = shooting_handlers._get_accurate_hex_line(10, 5, 6, 11)
print(f"Path: {hex_path}")
print(f"Path length: {len(hex_path)}")

# Expected walls in path based on scenario
walls = {(8, 7), (8, 8), (8, 9), (6, 10)}  # Known walls from step log

print("\nChecking for walls in path (excluding start/end):")
for i, (col, row) in enumerate(hex_path):
    if i == 0 or i == len(hex_path) - 1:
        status = "(SKIP - endpoint)"
    elif (col, row) in walls:
        status = "BLOCKED BY WALL!"
    else:
        status = "clear"
    print(f"  [{i}] ({col}, {row}) - {status}")

# Now test with actual game_state
print("\n" + "=" * 60)
print("FULL LOS TEST WITH GAME STATE")
print("=" * 60)

# Load actual scenario
import json
scenario_path = "config/agents/SpaceMarine_Infantry_Troop_RangedSwarm/scenarios/SpaceMarine_Infantry_Troop_RangedSwarm_scenario_bot-1.json"
try:
    with open(scenario_path, 'r') as f:
        scenario = json.load(f)
    print(f"\nLoaded scenario: {scenario_path}")

    wall_hexes_raw = scenario.get("wall_hexes", [])
    print(f"Wall hexes in scenario: {len(wall_hexes_raw)}")

    # Convert to set of tuples (as w40k_core.py does)
    wall_hexes = set(map(tuple, wall_hexes_raw))
    print(f"Wall hexes as set: {len(wall_hexes)}")

    # Check if (8,7), (8,8), (8,9), (6,10) are in walls
    test_walls = [(8, 7), (8, 8), (8, 9), (6, 10)]
    print("\nChecking if blocking walls exist:")
    for wall in test_walls:
        exists = wall in wall_hexes
        print(f"  {wall} in walls: {exists}")

except FileNotFoundError:
    print(f"Scenario file not found: {scenario_path}")
    wall_hexes = set()

# Create mock game_state
game_state = {
    "wall_hexes": wall_hexes,
    "units": []
}

# Mock shooter and target
shooter = {"id": "unit_5", "col": 10, "row": 5}
target = {"id": "unit_2", "col": 6, "row": 11}

print(f"\nShooter: {shooter}")
print(f"Target: {target}")

# Test LoS
print("\n" + "=" * 60)
print("_has_line_of_sight RESULT:")
print("=" * 60)
has_los = shooting_handlers._has_line_of_sight(game_state, shooter, target)
print(f"Result: {has_los}")

if has_los:
    print("\n*** BUG CONFIRMED: LoS should be BLOCKED but returned True! ***")
else:
    print("\n*** LoS correctly returns False (blocked) ***")

# Manual verification
print("\n" + "=" * 60)
print("MANUAL VERIFICATION:")
print("=" * 60)
for i, (col, row) in enumerate(hex_path):
    if i == 0 or i == len(hex_path) - 1:
        continue
    if (col, row) in wall_hexes:
        print(f"  Path hex ({col}, {row}) IS IN wall_hexes set")
        print("  -> Shot SHOULD be blocked here")
