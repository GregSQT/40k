#!/usr/bin/env python3
"""
Run a full episode with explicit LoS tracing.
"""
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# Patch shooting_handlers to trace LoS
from engine.phase_handlers import shooting_handlers

# Store original function
_original_has_los = shooting_handlers._has_line_of_sight

def _traced_has_los(game_state, shooter, target):
    """Wrapper with tracing"""
    result = _original_has_los(game_state, shooter, target)

    # Only trace specific unit pairs
    if shooter["id"] == "unit_5" and target["id"] == "unit_2":
        print(f"\n[LOS TRACE] unit_5 ({shooter['col']},{shooter['row']}) -> unit_2 ({target['col']},{target['row']})")

        # Check wall_hexes
        wall_hexes = game_state.get("wall_hexes", set())
        print(f"  wall_hexes type: {type(wall_hexes)}, count: {len(wall_hexes)}")

        # Check specific walls
        for wall in [(8,7), (8,8), (8,9), (6,10)]:
            print(f"    {wall} in walls: {wall in wall_hexes}")

        # Show path
        hex_path = shooting_handlers._get_accurate_hex_line(
            shooter["col"], shooter["row"],
            target["col"], target["row"]
        )
        print(f"  Path: {hex_path}")
        print(f"  Result: {result}")

    return result

# Apply patch
shooting_handlers._has_line_of_sight = _traced_has_los

# Now run test
from ai.train import main
import argparse

# Minimal args for test-only mode
sys.argv = [
    'test_los_full_episode.py',
    '--training-config', 'default',
    '--rewards-config', 'SpaceMarine_Infantry_Troop_RangedSwarm',
    '--agent', 'SpaceMarine_Infantry_Troop_RangedSwarm',
    '--scenario', 'bot',
    '--test-only',
    '--test-episodes', '1'
]

print("Running test episode with LoS tracing...")
print("Look for [LOS TRACE] output for unit_5 -> unit_2")
print("="*60)

try:
    main()
except SystemExit:
    pass
